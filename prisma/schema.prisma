generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

///////////////////////
// ENUMS
///////////////////////

enum Role {
  ADMIN
  USER
}

///////////////////////
// USER
///////////////////////

model User {
  id           Int      @id @default(autoincrement())
  name         String
  phone        String   @unique
  passwordHash String
  role         Role     @default(USER)
  active       Boolean  @default(true)
  createdAt    DateTime @default(now())

  // Rate Limit / Security
  failedLoginAttempts Int      @default(0)
  lockUntil           DateTime?

  // Captcha Security
  failedCaptchaAttempts   Int   @default(0)  
  captchaBlockedUntil     DateTime? 

  counts Count[]

  @@index([phone])
}

///////////////////////
// DRINKS / LAGER
///////////////////////

model Drink {
  id            Int      @id @default(autoincrement())
  name          String
  stock         Int      @default(0)  // Gesamtflaschen
  unitsPerCase  Int      // Flaschen pro Kiste
  createdAt     DateTime @default(now())

  counts Count[]

  @@unique([name])
}

///////////////////////
// STRICHLISTE
///////////////////////

model Count {
  id       Int @id @default(autoincrement())
  userId   Int
  drinkId  Int
  amount   Int @default(0)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  drink Drink @relation(fields: [drinkId], references: [id], onDelete: Cascade)

  @@unique([userId, drinkId])
  @@index([userId])
  @@index([drinkId])
}
